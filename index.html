<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="apple-touch-icon" href="icon.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Balƒ±k√ßƒ± Hasan</title>
    <style>
        :root {
            --bg: #1a1c23;
            --panel: #1e293b;
            --primary: #3b82f6;
            --accent: #10b981;
            --gold: #f59e0b;
            --danger: #ef4444;
            --text: #f1f5f9;
            --glass: rgba(15, 23, 42, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; font-family: -apple-system, system-ui, sans-serif; }
        
        body {
            margin: 0; padding: 0; height: 100dvh; overflow: hidden;
            background: #0f172a;
            color: var(--text); display: flex; flex-direction: column;
        }

        /* --- INTRO EKRANI --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #020617; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .intro-logo {
            font-size: 6rem; margin-bottom: 20px;
            animation: spin-bounce 3s ease-in-out infinite;
        }
        .intro-text {
            font-size: 1.2rem; color: #94a3b8; letter-spacing: 2px;
            animation: fadeIn 2s ease-in;
            font-family: 'Courier New', monospace; font-weight: bold;
        }
        @keyframes spin-bounce {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ARKA PLANLAR --- */
        .bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; transition: background 1s ease; }
        .bg-loc-0 { background: linear-gradient(to bottom, #87CEEB, #2E8B57); }
        .bg-loc-1 { background: linear-gradient(to bottom, #708090, #556B2F); }
        .bg-loc-2 { background: linear-gradient(to bottom, #00BFFF, #D2691E); }
        .bg-loc-3 { background: linear-gradient(to bottom, #4682B4, #006994); }
        .bg-loc-4 { background: linear-gradient(to bottom, #00CED1, #008B8B); }
        .bg-loc-5 { background: linear-gradient(to bottom, #191970, #000080); }
        .bg-loc-6 { background: linear-gradient(to bottom, #228B22, #3E2723); }
        .bg-loc-7 { background: linear-gradient(to bottom, #B0C4DE, #2F4F4F); }
        .bg-loc-8 { background: linear-gradient(to bottom, #000000, #0a0a2a); }
        .bg-loc-9 { background: linear-gradient(to bottom, #E0FFFF, #FFFFFF); }

        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 0;
        }

        /* --- HAVA DURUMU --- */
        #weather-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;
            display: none;
        }
        .rain-drop {
            position: absolute; width: 2px; height: 15px; background: rgba(255,255,255,0.4);
            animation: rainFall 0.5s linear infinite;
        }
        @keyframes rainFall { from {transform: translateY(-20px);} to {transform: translateY(100vh);} }
        .weather-storm { background: rgba(0,0,0,0.3); }

        /* --- ANA MEN√ú --- */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 2000; display: none;
            flex-direction: column; justify-content: center; align-items: center; gap: 20px; padding: 20px;
        }
        .game-title {
            font-size: 3.5rem; font-weight: 900; color: transparent;
            background: linear-gradient(to right, #3b82f6, #10b981);
            -webkit-background-clip: text; background-clip: text;
            text-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; text-align: center; line-height: 1.1;
        }
        .menu-btn {
            width: 80%; max-width: 300px; padding: 15px; border: none;
            border-radius: 15px; font-size: 1.2rem; font-weight: bold;
            color: white; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .menu-btn:active { transform: scale(0.95); }
        .btn-continue { background: var(--primary); }
        .btn-new { background: #475569; border: 1px solid #64748b; }
        
        .credits { position: absolute; bottom: 30px; color: rgba(255,255,255,0.5); font-size: 0.9rem; font-family: 'Courier New', monospace; letter-spacing: 1px; }

        /* --- OYUN ƒ∞√áƒ∞ UI --- */
        header {
            padding: 10px 15px; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex; justify-content: space-between; z-index: 10; padding-top: max(15px, env(safe-area-inset-top)); align-items: center;
        }
        .stat-pill { background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); font-weight: bold;}
        
        .menu-back-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;
        }

        #scene { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;}
        
        .location-sign {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 8px; z-index: 5;
        }
        .sign-icon { font-size: 1.5rem; }
        .sign-text { font-size: 1rem; font-weight: 700; color: #fff; letter-spacing: 0.5px; text-transform: uppercase; }
        .weather-icon { margin-left: 5px; font-size: 1.2rem; }

        #rod-visual {
            position: absolute; bottom: -60px; right: -40px; width: 300px; pointer-events: none;
            transition: transform 0.3s; transform-origin: bottom right; z-index: 6;
            filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.5));
        }
        .rod-idle { transform: rotate(0deg); }
        .rod-cast { animation: castAnim 0.5s forwards; }
        @keyframes castAnim { 0%{transform:rotate(0deg)} 50%{transform:rotate(15deg)} 100%{transform:rotate(-40deg)} }

        .bobber {
            width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #ff4444, #990000);
            border-radius: 50%; border: 2px solid white;
            position: absolute; bottom: 40%; left: 50%; transform: translate(-50%, 0) scale(0);
            box-shadow: 0 0 15px rgba(255,255,255,0.8); transition: transform 0.2s; z-index: 4;
        }
        .bobber.active { transform: translate(-50%, 0) scale(1); animation: bob 2s infinite ease-in-out; }
        @keyframes bob { 0%,100%{margin-bottom:0} 50%{margin-bottom:-5px} }

        /* Mƒ∞Nƒ∞ OYUN */
        #minigame-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50; display: none;
            flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .mg-track {
            width: 85%; height: 40px; background: #0f172a; border-radius: 20px; border: 2px solid #475569;
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .mg-target {
            position: absolute; top: 0; height: 100%; background: rgba(16, 185, 129, 0.8);
            border-left: 2px solid #34d399; border-right: 2px solid #34d399;
            box-shadow: 0 0 15px #10b981;
        }
        .mg-cursor {
            position: absolute; top: -5px; width: 6px; height: 50px; background: #fff;
            box-shadow: 0 0 10px #fff; left: 0%; transition: none; border-radius: 2px;
        }
        .mg-info { font-size: 1.5rem; font-weight: 900; color: white; margin-bottom: 15px; }

        /* CONTROLS */
        #controls {
            background: var(--glass); padding: 20px; border-radius: 25px 25px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8); z-index: 40; padding-bottom: max(20px, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .main-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%); color: white;
            border: none; border-radius: 16px; font-size: 1.2rem; font-weight: 800;
            letter-spacing: 1px; box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
            margin-bottom: 15px; active: scale(0.98); transition: 0.2s;
        }
        .main-btn:disabled { background: #334155; opacity: 0.7; box-shadow: none; color: #94a3b8; }

        .menu-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .menu-item {
            background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 2px;
            display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); position: relative; transition: 0.2s;
        }
        .menu-item:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
        .menu-icon { font-size: 1.4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .menu-text { font-size: 0.6rem; font-weight: 700; color: #cbd5e1; }
        
        .badge {
            position: absolute; top: -2px; right: -2px; width: 10px; height: 10px;
            background: var(--danger); border-radius: 50%; border: 2px solid var(--panel);
            display: none; box-shadow: 0 0 5px var(--danger);
        }

        /* MODALS */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none; opacity: 0;
            transition: opacity 0.3s; backdrop-filter: blur(5px);
        }
        .modal {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 85%;
            background: #1e293b; border-radius: 25px 25px 0 0; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: 0 -10px 50px black; border-top: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header { 
            padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); z-index: 10;
        }
        .modal-title { font-size: 1.2rem; font-weight: 800; letter-spacing: 0.5px; color: white; }
        .modal-close { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            padding: 15px; margin-bottom: 8px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .item-left { display: flex; flex-direction: column; gap: 3px; }
        .item-name { font-weight: 700; font-size: 0.95rem; }
        .item-desc { font-size: 0.75rem; color: #94a3b8; }
        .btn-small { padding: 8px 14px; border-radius: 8px; border: none; font-size: 0.8rem; font-weight: bold; background: var(--primary); color: white; margin-left: 5px; }

        /* TOAST */
        #toast {
            position: absolute; top: 130px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 50px;
            font-weight: bold; font-size: 1rem; opacity: 0; pointer-events: none; 
            transition: opacity 0.3s; white-space: nowrap; z-index: 200;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        #toast-sub { font-size: 0.75rem; color: #aaa; font-weight: normal; display: block; }
    </style>
</head>
<body>

<!-- INTRO -->
<div id="intro-screen">
    <div class="intro-logo">üé£</div>
    <div class="intro-text">made by Fƒ±rat Yƒ±ldƒ±rƒ±m</div>
</div>

<!-- ANA MEN√ú -->
<div id="main-menu">
    <div class="game-title">BALIK√áI<br>HASAN</div>
    <button class="menu-btn btn-continue" id="btn-resume" onclick="startGame()" style="display:none">DEVAM ET</button>
    <button class="menu-btn btn-new" onclick="startNewGame()">YENƒ∞ OYUN</button>
    <div class="credits">made by Fƒ±rat Yƒ±ldƒ±rƒ±m</div>
</div>

<!-- ARKA PLAN -->
<div id="bg-layer" class="bg-layer bg-loc-0"></div>
<div id="weather-layer"></div>
<div class="vignette"></div>

<!-- SAHNE -->
<div id="scene">
    <div class="location-sign">
        <span class="sign-icon" id="loc-icon-display">üå≤</span>
        <span class="sign-text" id="loc-name-display">K√∂y Deresi</span>
        <span class="weather-icon" id="weather-icon-display">‚òÄÔ∏è</span>
    </div>

    <div id="toast"><span id="toast-msg"></span><span id="toast-sub"></span></div>
    <div class="bobber" id="bobber"></div>
    
    <svg id="rod-visual" viewBox="0 0 200 300" class="rod-idle">
        <path d="M180,300 Q100,200 20,20" stroke="#8b5cf6" stroke-width="4" fill="none" stroke-linecap="round"/>
        <path d="M190,310 L170,290" stroke="#333" stroke-width="15" stroke-linecap="round"/>
        <path d="M20,20 L20,150" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
    </svg>
</div>

<!-- Mƒ∞Nƒ∞ OYUN -->
<div id="minigame-layer" onclick="handleMiniGameClick()">
    <div class="mg-info">üéØ HEDEFƒ∞ TUTTUR!</div>
    <div class="mg-track">
        <div class="mg-target" id="mg-target"></div>
        <div class="mg-cursor" id="mg-cursor"></div>
    </div>
    <div style="font-size:0.9rem; opacity:0.8; margin-top:10px;">Yakalamak i√ßin ekrana dokun</div>
</div>

<!-- √úST Bƒ∞LGƒ∞ -->
<header>
    <div class="stat-pill">XP: <span id="xp-val">0 / 300</span> (Lv.<span id="lvl-val">1</span>)</div>
    <button class="menu-back-btn" onclick="exitToMenu()">MEN√ú</button>
    <div class="stat-pill" style="color:var(--gold); border-color:rgba(245, 158, 11, 0.3)">üí∞ <span id="money-val">0</span> TL</div>
</header>

<!-- ALT KONTROLLER -->
<div id="controls">
    <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:0.85rem; color:#cbd5e1; font-weight:600;">
        <span>Olta: <span id="hp-val" style="color:var(--danger);">10/10</span></span>
        <span>Yem: <span id="bait-val" style="color:var(--accent);">Yok</span></span>
    </div>
    
    <button class="main-btn" id="cast-btn" onclick="startFishing()">OLTA AT</button>
    
    <div class="menu-grid">
        <div class="menu-item" onclick="openModal('bag')">
            <span class="menu-icon">üéí</span><span class="menu-text">√áanta</span>
            <span id="bag-count" style="position:absolute; top:-5px; right:-5px; font-size:0.65rem; background:var(--primary); padding:2px 6px; border-radius:10px; border:2px solid var(--panel);">0</span>
        </div>
        <div class="menu-item" onclick="openModal('aqua')">
            <span class="menu-icon">üê†</span><span class="menu-text">Akvaryum</span>
        </div>
        <div class="menu-item" onclick="openModal('quests')">
            <div class="badge" id="quest-badge"></div>
            <span class="menu-icon">üìú</span><span class="menu-text">Hedefler</span>
        </div>
        <div class="menu-item" onclick="openModal('pedia')">
            <span class="menu-icon">üìñ</span><span class="menu-text">Rehber</span>
        </div>
        <div class="menu-item" onclick="openModal('shop')">
            <span class="menu-icon">üõí</span><span class="menu-text">Market</span>
        </div>
    </div>
    <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="menu-item" style="flex-direction:row; justify-content:center;" onclick="openModal('travel')">
            <span class="menu-icon">üó∫Ô∏è</span><span class="menu-text" style="font-size:0.85rem">Harita</span>
        </div>
        <div class="menu-item" style="flex-direction:row; justify-content:center;" onclick="openModal('skills')">
            <span class="menu-icon">üß†</span><span class="menu-text" style="font-size:0.85rem">Yetenek</span>
        </div>
    </div>
</div>

<!-- MODALLAR -->
<div class="overlay" id="modal-overlay" onclick="closeModal()">
    <div class="modal" id="active-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title" id="modal-title">Ba≈ülƒ±k</span>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-content" id="modal-body"></div>
    </div>
</div>

<script>
    /* --- INTRO LOGIC --- */
    window.onload = function() {
        setTimeout(() => {
            document.getElementById('intro-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('main-menu').style.display = 'flex';
                init();
            }, 500);
        }, 3000);
    };

    /* --- VERƒ∞LER --- */
    const RODS = [
        {id:0, n:"S√∂ƒü√ºt Dalƒ±", p:0, hp:10, pow:1, col:"#8b4513"}, 
        {id:1, n:"Bambu Kamƒ±≈ü", p:300, hp:18, pow:1.2, col:"#d4a373"},
        {id:2, n:"Fiberglass", p:1000, hp:28, pow:1.5, col:"#cbd5e1"},
        {id:3, n:"Kompozit", p:2500, hp:40, pow:1.8, col:"#475569"},
        {id:4, n:"Karbon Spin", p:6000, hp:55, pow:2.2, col:"#1e293b"},
        {id:5, n:"Surf Casting", p:12000, hp:75, pow:2.8, col:"#f59e0b"},
        {id:6, n:"Tekne Pro", p:30000, hp:100, pow:3.5, col:"#dc2626"},
        {id:7, n:"Turnuva Serisi", p:75000, hp:130, pow:4.5, col:"#3b82f6"},
        {id:8, n:"Titanyum", p:200000, hp:180, pow:6.0, col:"#a855f7"},
        {id:9, n:"Efsanevi Usta", p:600000, hp:300, pow:10.0, col:"#10b981"}
    ];

    const SKILLS = [
        {id:'luck', n:'≈ûans', d:'Nadir balƒ±k ihtimali', max:5, reqLvl:2},
        {id:'haggle', n:'Pazarlƒ±k', d:'%10 daha pahalƒ± sat', max:5, reqLvl:3},
        {id:'repair', n:'Bakƒ±m', d:'Olta hasarƒ±nƒ± azalt', max:5, reqLvl:5},
        {id:'biology', n:'Biyoloji', d:'Daha b√ºy√ºk balƒ±klar', max:5, reqLvl:8}
    ];
    
    const LOCS = [
        {id:0, n:"K√∂y Deresi", p:0, i:"üå≤"}, {id:1, n:"Sazlƒ±k G√∂l", p:500, i:"ü¶Ü"},
        {id:2, n:"Kayalƒ±k Sahil", p:2000, i:"ü¶Ä"}, {id:3, n:"B√ºy√ºk Nehir", p:5000, i:"üèûÔ∏è"},
        {id:4, n:"Mercan Resifi", p:12000, i:"üê†"}, {id:5, n:"A√ßƒ±k Okyanus", p:25000, i:"üåä"},
        {id:6, n:"Amazon Nehri", p:60000, i:"üå¥"}, {id:7, n:"Norve√ß Fiyort", p:150000, i:"üèîÔ∏è"},
        {id:8, n:"Derin √áukur", p:500000, i:"üåë"}, {id:9, n:"Antarktika", p:1000000, i:"‚ùÑÔ∏è"}
    ];
    const BAITS = [
        {id:'bread', n:'Ekmek', p:15, b:1.0}, {id:'worm', n:'Solucan', p:60, b:1.2},
        {id:'corn', n:'Mƒ±sƒ±r', p:120, b:1.3}, {id:'shrimp', n:'Karides', p:500, b:1.6},
        {id:'lure', n:'Ka≈üƒ±k', p:1200, b:2.0}, {id:'squid', n:'Kalamar', p:3000, b:2.5}, {id:'live', n:'Canlƒ±', p:6000, b:3.0}
    ];
    const FISH_DB = {
        0: [{n:"Eski √áizme",t:"junk",v:0,r:1,e:"üë¢"}, {n:"Teneke",t:"junk",v:0,r:1,e:"ü•´"}, {n:"Sazan",t:"fish",v:15,r:1,e:"üêü"}, {n:"Kƒ±zƒ±lkanat",t:"fish",v:25,r:2,e:"üê†"}, {n:"Kefal",t:"fish",v:35,r:3,e:"üêü"}, {n:"Dere Alasƒ±",t:"fish",v:60,r:4,e:"üêü"}, {n:"Altƒ±n Y√ºz√ºk",t:"treasure",v:250,r:5,e:"üíç"}],
        1: [{n:"Yosun",t:"junk",v:5,r:1,e:"üåø"}, {n:"Lastik",t:"junk",v:0,r:1,e:"‚ö´"}, {n:"Turna",t:"fish",v:70,r:2,e:"ü¶à"}, {n:"Kadife",t:"fish",v:9,r:3,e:"üêü"}, {n:"Yayƒ±n",t:"fish",v:180,r:4,e:"üêã"}, {n:"G√∂l Canavarƒ±",t:"fish",v:600,r:5,e:"üêâ"}, {n:"Kƒ±rmƒ±zƒ± Balƒ±k",t:"fish",v:5000,r:6,e:"üî¥"}],
        2: [{n:"Plastik",t:"junk",v:10,r:1,e:"ü•§"}, {n:"ƒ∞stavrit",t:"fish",v:35,r:1,e:"üêü"}, {n:"Mezgit",t:"fish",v:50,r:2,e:"üêü"}, {n:"Levrek",t:"fish",v:120,r:3,e:"üê†"}, {n:"√áipura",t:"fish",v:150,r:3,e:"üêü"}, {n:"Antik Sikke",t:"treasure",v:900,r:5,e:"ü™ô"}],
        3: [{n:"K√ºt√ºk",t:"junk",v:10,r:1,e:"ü™µ"}, {n:"G√∂kku≈üaƒüƒ±",t:"fish",v:180,r:2,e:"üåà"}, {n:"Somon",t:"fish",v:250,r:3,e:"üêü"}, {n:"Mersin",t:"fish",v:500,r:4,e:"ü¶à"}, {n:"Dev Turna",t:"fish",v:700,r:5,e:"üêä"}],
        4: [{n:"√ñl√º Mercan",t:"junk",v:20,r:1,e:"ü™∏"}, {n:"Palya√ßo",t:"fish",v:200,r:2,e:"üê†"}, {n:"Cerrah",t:"fish",v:220,r:2,e:"üêü"}, {n:"M√ºren",t:"fish",v:350,r:3,e:"üêç"}, {n:"Kaplumbaƒüa",t:"fish",v:600,r:4,e:"üê¢"}, {n:"ƒ∞nci",t:"treasure",v:2000,r:5,e:"‚ö™"}],
        5: [{n:"Halat",t:"junk",v:0,r:1,e:"ü™¢"}, {n:"Uskumru",t:"fish",v:90,r:2,e:"üêü"}, {n:"Palamut",t:"fish",v:130,r:2,e:"üêü"}, {n:"Orkinos",t:"fish",v:700,r:4,e:"üêü"}, {n:"Kƒ±lƒ±√ß",t:"fish",v:1500,r:5,e:"üó°Ô∏è"}, {n:"B√ºy√ºk Beyaz",t:"fish",v:3000,r:5,e:"ü¶à"}],
        6: [{n:"√áamur",t:"junk",v:0,r:1,e:"üí©"}, {n:"Pirana",t:"fish",v:300,r:3,e:"ü¶∑"}, {n:"Tavus Ku≈üu",t:"fish",v:450,r:3,e:"üê†"}, {n:"Elektrikli",t:"fish",v:900,r:4,e:"‚ö°"}, {n:"Arapaima",t:"fish",v:3500,r:5,e:"üêä"}],
        7: [{n:"Aƒü",t:"junk",v:20,r:1,e:"üï∏Ô∏è"}, {n:"Ringa",t:"fish",v:120,r:2,e:"üêü"}, {n:"Morina",t:"fish",v:500,r:3,e:"üêü"}, {n:"Kral Somon",t:"fish",v:900,r:4,e:"üêü"}, {n:"Kral Yenge√ß",t:"fish",v:1800,r:5,e:"ü¶Ä"}],
        8: [{n:"Paslƒ± Metal",t:"junk",v:50,r:1,e:"üî©"}, {n:"Engerek",t:"fish",v:900,r:3,e:"üêç"}, {n:"Fener",t:"fish",v:2500,r:4,e:"üî¶"}, {n:"Dev Kalamar",t:"fish",v:6000,r:5,e:"ü¶ë"}, {n:"Hazine",t:"treasure",v:15000,r:5,e:"üíé"}],
        9: [{n:"Fosil",t:"junk",v:500,r:1,e:"ü¶ï"}, {n:"Buzul Balƒ±ƒüƒ±",t:"fish",v:1200,r:3,e:"‚ùÑÔ∏è"}, {n:"Kutup Morinasƒ±",t:"fish",v:2500,r:4,e:"üêü"}, {n:"Dev Balina",t:"fish",v:10000,r:5,e:"üê≥"}, {n:"Antik Kalƒ±ntƒ±",t:"treasure",v:30000,r:5,e:"üè∫"}]
    };

    const game = {
        money: 0, xp: 0, level: 1,
        bag: [], bagLimit: 5,
        rodId: 0, rodHp: 10,
        locId: 0, unlockedLocs: [0], ownedRods: [0],
        bait: null,
        skills: { luck:0, haggle:0, repair:0, biology:0 },
        pedia: {}, quests: [], aquarium: [], aquaLimit: 10, lastLogin: Date.now(),
        questCooldown: 0
    };

    let state = "IDLE";
    let mgAnim, activeFish;
    let weather = "Sunny";
    let passiveInterval;

    function init() {
        if(localStorage.getItem("balikciHasanSave_v4")) {
            document.getElementById("btn-resume").style.display = "block";
        }
    }

    function startGame() {
        document.getElementById("main-menu").style.display = "none";
        loadGame();
        if(!game.quests.length) genQuests();
        
        if(passiveInterval) clearInterval(passiveInterval);
        passiveInterval = setInterval(() => {
            let income = calcAquaIncome();
            if(income > 0) {
                game.money += income;
                showToast(`+${income} TL (Akvaryum)`, "var(--gold)");
                updateUI();
            }
            checkBreeding();
        }, 60000);

        setInterval(updateWeather, 45000);
        setInterval(seagullEvent, 45000);
        updateUI();
        changeLoc(game.locId);
        updateRodVisual();
    }

    function startNewGame() {
        // Yeni oyun butonuna basƒ±nca direkt sƒ±fƒ±rla
        localStorage.removeItem("balikciHasanSave_v4");
        game.money=0; game.xp=0; game.level=1; game.bag=[]; game.bagLimit=5;
        game.rodId=0; game.rodHp=10; game.locId=0; game.unlockedLocs=[0];
        game.ownedRods=[0]; game.bait=null; game.skills={luck:0,haggle:0,repair:0,biology:0};
        game.pedia={}; game.quests=[]; game.aquarium=[]; game.aquaLimit=7; game.questCooldown=0;
        game.lastLogin = Date.now();
        
        startGame();
    }

    function exitToMenu() {
        saveGame();
        document.getElementById("main-menu").style.display = "flex";
        document.getElementById("btn-resume").style.display = "block";
    }

    /* --- HAVA DURUMU --- */
    function updateWeather() {
        let rnd = Math.random();
        let wLayer = document.getElementById("weather-layer");
        wLayer.innerHTML = "";
        wLayer.style.display = "block";
        if(rnd < 0.2) {
            weather = "Storm"; wLayer.className = "weather-storm"; createRain(true); showToast("Fƒ±rtƒ±na √áƒ±ktƒ±!", "#aaa");
        } else if(rnd < 0.5) {
            weather = "Rain"; wLayer.className = ""; createRain(false); showToast("Yaƒümur Ba≈üladƒ±", "#ccc");
        } else {
            weather = "Sunny"; wLayer.style.display = "none";
        }
        document.getElementById("weather-icon-display").innerText = weather==="Sunny"?"‚òÄÔ∏è":weather==="Rain"?"üåßÔ∏è":"‚õàÔ∏è";
    }

    function createRain(isStorm) {
        let count = isStorm ? 50 : 20;
        let layer = document.getElementById("weather-layer");
        for(let i=0; i<count; i++) {
            let d = document.createElement("div"); d.className = "rain-drop";
            d.style.left = Math.random()*100 + "%"; d.style.animationDuration = (Math.random()*0.5 + 0.3) + "s";
            d.style.animationDelay = Math.random() + "s"; layer.appendChild(d);
        }
    }

    /* --- OYUN MEKANƒ∞KLERƒ∞ --- */
    function startFishing() {
        if(game.rodHp <= 0) { showToast("‚ö†Ô∏è Olta Kƒ±rƒ±k!", "red"); return; }
        if(game.bag.length >= game.bagLimit) { showToast("‚ö†Ô∏è √áanta Dolu!", "orange"); return; }

        document.getElementById("cast-btn").disabled = true;
        document.getElementById("cast-btn").innerText = "BEKLENƒ∞YOR...";
        document.getElementById("rod-visual").classList.add("rod-cast");
        document.getElementById("bobber").classList.add("active");

        state = "WAITING";
        let waitBase = 2000; if(weather === "Rain") waitBase = 1500;
        setTimeout(triggerBite, waitBase + Math.random() * 2500);
    }

    function triggerBite() {
        if(state !== "WAITING") return;
        activeFish = pickFish();
        if(activeFish.t === 'junk') catchSuccess(); else startMiniGame();
    }

    function startMiniGame() {
        state = "MINIGAME";
        const layer = document.getElementById("minigame-layer");
        const target = document.getElementById("mg-target");
        layer.style.display = "flex";
        let diff = activeFish.r + (game.locId * 0.3);
        if(weather==="Storm") diff += 1;
        let targetWidth = Math.max(8, 35 - (diff * 3.5));
        let speed = 1.0 + (diff * 0.3);
        let targetLeft = Math.random() * (90 - targetWidth);
        target.style.width = targetWidth + "%";
        target.style.left = targetLeft + "%";
        let pos = 0, dir = 1;
        function loop() {
            if(state !== "MINIGAME") return;
            pos += dir * speed;
            if(pos > 100 || pos < 0) dir *= -1;
            document.getElementById("mg-cursor").style.left = pos + "%";
            mgAnim = requestAnimationFrame(loop);
        }
        loop();
    }

    function handleMiniGameClick() {
        if(state !== "MINIGAME") return;
        cancelAnimationFrame(mgAnim);
        const cursor = parseFloat(document.getElementById("mg-cursor").style.left);
        const tLeft = parseFloat(document.getElementById("mg-target").style.left);
        const tWidth = parseFloat(document.getElementById("mg-target").style.width);
        
        let hitBoxStart = tLeft - 5;
        let hitBoxEnd = tLeft + tWidth + 5;
        
        if(cursor >= hitBoxStart && cursor <= hitBoxEnd) {
            if(checkLineSnap()) { showToast("Mƒ∞Sƒ∞NA KOPTU!", "#ef4444"); catchFail(true); } 
            else { showToast("M√úKEMMEL!", "#10b981"); setTimeout(catchSuccess, 300); }
        } else {
            showToast("KA√áTI!", "#ef4444"); setTimeout(() => catchFail(false), 300);
        }
        document.getElementById("minigame-layer").style.display = "none";
    }

    function checkLineSnap() {
        let rod = RODS[game.rodId];
        let risk = (activeFish.r * 12) - (rod.pow * 6);
        if(weather === "Storm") risk += 5;
        return Math.random() * 100 < Math.max(1, risk);
    }

    function catchSuccess() {
        resetState();
        game.rodHp = Math.max(0, game.rodHp - (1 - (game.skills.repair * 0.1)));
        let weight = (Math.random() * 5 + 1) * (1 + game.skills.biology * 0.2) * (1 + game.locId * 0.3);
        activeFish.w = weight.toFixed(2);
        game.bag.push({...activeFish});
        if(!game.pedia[activeFish.n]) game.pedia[activeFish.n] = {count:0, maxW:0};
        game.pedia[activeFish.n].count++;
        if(weight > game.pedia[activeFish.n].maxW) game.pedia[activeFish.n].maxW = weight;
        checkQuests(activeFish);
        let xpGain = activeFish.r * 12 * (1 + game.locId * 0.1);
        gainXp(Math.floor(xpGain));
        
        if(activeFish.n === "Kƒ±rmƒ±zƒ± Balƒ±k") showToast("EFSANEVƒ∞ KIRMIZI BALIK!", "#ff0055", "Tebrikler!");
        else showToast(`+ ${activeFish.n}`, activeFish.t === 'treasure' ? 'gold' : 'white');
        
        if(game.bait) game.bait = null;
        advanceQuestCycle();
        saveGame(); updateUI();
    }

    function catchFail(snapped) { 
        resetState(); game.rodHp -= snapped ? 3 : 1; if(game.rodHp < 0) game.rodHp = 0; 
        advanceQuestCycle(); saveGame(); updateUI(); 
    }

    function resetState() {
        state = "IDLE";
        document.getElementById("cast-btn").disabled = false;
        document.getElementById("cast-btn").innerText = "OLTA AT";
        document.getElementById("rod-visual").classList.remove("rod-cast");
        document.getElementById("bobber").classList.remove("active");
    }

    function pickFish() {
        let pool = FISH_DB[game.locId];
        let rod = RODS[game.rodId];
        let baitBonus = game.bait ? BAITS.find(b=>b.id===game.bait).b : 1;
        let totalW = 0;
        let wPool = pool.map(f => {
            let w = 100 / Math.pow(2, f.r); 
            if(f.t !== 'junk') w *= (rod.pow * baitBonus * (1 + game.skills.luck*0.1)); else w /= (rod.pow);
            if(weather==="Rain" && f.t==='fish') w *= 1.2;
            totalW += w;
            return {...f, weight: w};
        });
        let r = Math.random() * totalW;
        for(let f of wPool) { if(r < f.weight) return f; r -= f.weight; }
        return wPool[0];
    }

    function gainXp(amount) {
        game.xp += amount;
        let req = game.level * 300;
        if(game.xp >= req) {
            game.xp -= req; game.level++; 
            game.aquaLimit = 5 + (game.level * 2);
            showToast("SEVƒ∞YE ATLADIN!", "#f59e0b", `Akvaryum: ${game.aquaLimit} kapasite`);
        }
    }

    function genQuests() {
        let mult = game.locId + 1;
        game.quests = [
            {desc: "3 Balƒ±k Tut", target: 3, current: 0, reward: 100 * mult, claimed: false, type:'count'},
            {desc: "Gelir Elde Et", target: 200 * mult, current: 0, reward: 150 * mult, claimed: false, type:'money'},
            {desc: "1 Nadir+ Balƒ±k", target: 1, current: 0, reward: 250 * mult, claimed: false, type:'rare'}
        ];
        game.questCooldown = 0;
    }

    function checkQuests(fish) {
        game.quests.forEach(q => {
            if(q.claimed) return;
            if(q.type === 'count' && fish.t !== 'junk') q.current++;
            if(q.type === 'rare' && fish.r >= 3) q.current++;
        });
    }

    function advanceQuestCycle() {
        if(game.quests.every(q => q.claimed)) {
            game.questCooldown = (game.questCooldown || 0) + 1;
            if(game.questCooldown >= 10) {
                genQuests(); showToast("Hedefler Yenilendi!", "var(--accent)");
            }
        }
    }

    function seagullEvent() {
        if(game.bag.length > 0 && Math.random() < 0.25) {
            let protection = game.bagLimit * 0.05;
            if(Math.random() > protection) {
                let idx = Math.floor(Math.random() * game.bag.length);
                let item = game.bag[idx];
                game.bag.splice(idx, 1);
                showToast("MARTI SALDIRISI!", "var(--danger)", `${item.n} √ßalƒ±ndƒ±!`);
                saveGame(); updateUI();
            }
        }
    }

    /* --- ƒ∞≈ûLEVLER --- */
    function sellSingleItem(index) {
        let item = game.bag[index];
        let bonus = 1 + (game.skills.haggle * 0.1);
        let price = item.t === 'junk' ? 1 : Math.floor(item.v * bonus);

        game.money += price;
        game.quests.forEach(q => { if(q.type === 'money' && !q.claimed) q.current += price; });
        
        game.bag.splice(index, 1);
        
        showToast(`Satƒ±ldƒ±: +${price} TL`, "var(--gold)");
        saveGame(); updateUI(); openModal('bag');
    }

    function sellFromAqua(index) {
        let fish = game.aquarium[index];
        let val = fish.v;
        game.money += val;
        game.aquarium.splice(index, 1);
        showToast(`Satƒ±ldƒ±: +${val} TL`, "var(--gold)");
        saveGame();
        openModal('aqua'); 
        updateUI();
    }

    function checkBreeding() {
        if(game.aquarium.length >= game.aquaLimit) return;
        let counts = {};
        game.aquarium.forEach(f => {
            if(!counts[f.n]) counts[f.n] = 0;
            counts[f.n]++;
        });
        for(let name in counts) {
            if(counts[name] >= 2) {
                if(Math.random() < 0.05) {
                    let parent = game.aquarium.find(f => f.n === name);
                    let baby = {...parent};
                    baby.w = (Math.random() * parent.w).toFixed(2);
                    game.aquarium.push(baby);
                    showToast(`Yavru doƒüdu: ${name}!`, "#ff69b4");
                    saveGame();
                    if(document.getElementById("active-modal").style.transform === "translateY(0px)") {
                        openModal('aqua');
                    }
                    break; 
                }
            }
        }
    }

    /* --- UI & MODAL --- */
    function updateUI() {
        document.getElementById("money-val").innerText = game.money.toLocaleString();
        let reqXp = game.level * 300;
        document.getElementById("xp-val").innerText = `${game.xp} / ${reqXp}`;
        document.getElementById("lvl-val").innerText = game.level;
        document.getElementById("hp-val").innerText = `${Math.ceil(game.rodHp)}/${RODS[game.rodId].hp}`;
        let bName = game.bait ? BAITS.find(b=>b.id===game.bait).n : "Yok";
        document.getElementById("bait-val").innerText = bName;
        document.getElementById("bag-count").innerText = `${game.bag.length}/${game.bagLimit}`;
        document.getElementById("loc-name-display").innerText = LOCS[game.locId].n;
        document.getElementById("loc-icon-display").innerText = LOCS[game.locId].i;
        let hasQ = game.quests.some(q => !q.claimed && q.current >= q.target);
        document.getElementById("quest-badge").style.display = hasQ ? "block" : "none";
        document.querySelector("#rod-visual path").setAttribute("stroke", RODS[game.rodId].col);
    }

    function updateRodVisual() { document.querySelector("#rod-visual path").setAttribute("stroke", RODS[game.rodId].col); }
    function changeLoc(id) { game.locId = id; document.getElementById("bg-layer").className = `bg-layer bg-loc-${id}`; closeModal(); saveGame(); updateUI(); }

    function openModal(type) {
        const overlay = document.getElementById("modal-overlay");
        const modal = document.getElementById("active-modal");
        const title = document.getElementById("modal-title");
        const body = document.getElementById("modal-body");
        
        overlay.style.display = "block";
        setTimeout(() => { overlay.style.opacity = 1; modal.style.transform = "translateY(0)"; }, 10);
        body.innerHTML = "";

        if(type === 'skills') {
            title.innerText = "Yetenekler";
            SKILLS.forEach(s => {
                let lvl = game.skills[s.id] || 0;
                let cost = (lvl+1)*500;
                let locked = game.level < s.reqLvl;
                let btnText = locked ? `Lv.${s.reqLvl}` : `${cost} TL`;
                let btnAction = locked ? "" : `onclick="buySkill('${s.id}', ${cost})"`;
                let btnStyle = locked ? "background:#444; color:#888" : "";
                if(lvl >= s.max) { btnText="MAX"; btnStyle="background:var(--accent)"; btnAction=""; }
                body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name">${s.n} (${lvl})</span><span class="item-desc">${s.d}</span></div><button class="btn-small" style="${btnStyle}" ${btnAction}>${btnText}</button></div>`;
            });
        } 
        else if(type === 'bag') {
            title.innerText = "√áanta";
            body.innerHTML = `<button class="main-btn" style="background:var(--accent)" onclick="sellAll()">T√ºm√ºn√º Sat</button>`;
            if(game.bag.length===0) body.innerHTML += "<div style='text-align:center;color:#666'>Bo≈ü</div>";
            game.bag.forEach((f, i) => {
                let aquaBtn = f.t!=='junk' ? `<button class="btn-small" onclick="addToAqua(${i})">Akvaryum</button>` : "";
                let sellBtn = `<button class="btn-small" style="background:var(--gold); color:black; margin-left:5px;" onclick="sellSingleItem(${i})">Sat</button>`;
                body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name">${f.e} ${f.n}</span><span class="item-desc">${f.w} kg - ${f.v} TL</span></div><div style="display:flex;">${aquaBtn}${sellBtn}</div></div>`;
            });
        }
        else if(type === 'aqua') {
            title.innerText = "Akvaryum";
            body.innerHTML = `<div style="text-align:center; margin-bottom:10px;">Gelir: <b>${calcAquaIncome()} TL/dk</b> (${game.aquarium.length}/${game.aquaLimit})</div>`;
            game.aquarium.forEach(f => { body.innerHTML += `<div style="display:inline-block; padding:5px; font-size:1.5rem;">${f.e}</div>`; });
            
            let listHtml = '<div style="margin-top:15px; padding-top:10px; border-top:1px solid #333;">';
            game.aquarium.forEach((f, i) => {
                listHtml += `<div class="list-item">
                    <div class="item-left"><span class="item-name">${f.e} ${f.n}</span><span class="item-desc">${f.w} kg</span></div>
                    <button class="btn-small" style="background:var(--danger)" onclick="sellFromAqua(${i}); event.stopPropagation();">Sat (${f.v} TL)</button>
                </div>`;
            });
            listHtml += '</div>';
            body.innerHTML += listHtml;
        }
        else if(type === 'shop') {
            title.innerText = "Market";
            body.innerHTML += "<h4>Yemler</h4>";
            BAITS.forEach(b => body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name">${b.n}</span><span class="item-desc">≈ûans x${b.b}</span></div><button class="btn-small" onclick="buyBait('${b.id}',${b.p})">${b.p} TL</button></div>`);
            body.innerHTML += "<h4>Oltalar</h4>";
            RODS.forEach(r => {
                let btn = game.ownedRods.includes(r.id) ? (game.rodId===r.id?"Aktif":`<button class="btn-small" onclick="equipRod(${r.id})">Ku≈üan</button>`) : `<button class="btn-small" onclick="buyRod(${r.id},${r.p})">${r.p} TL</button>`;
                body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name" style="color:${r.col}">${r.n}</span><span class="item-desc">Can: ${r.hp}</span></div>${btn}</div>`;
            });
            body.innerHTML += `<h4>Diƒüer</h4><div class="list-item"><div class="item-left"><span class="item-name">Tamir Et</span></div><button class="btn-small" style="background:var(--danger)" onclick="repair()">50 TL</button></div><div class="list-item"><div class="item-left"><span class="item-name">√áanta +5</span></div><button class="btn-small" onclick="upgBag()">500 TL</button></div>`;
        }
        else if(type === 'travel') {
            title.innerText = "Harita";
            LOCS.forEach(l => {
                let btn = game.unlockedLocs.includes(l.id) ? (game.locId===l.id?"Burada":`<button class="btn-small" onclick="changeLoc(${l.id})">Git</button>`) : `<button class="btn-small" style="background:var(--gold); color:black" onclick="unlockLoc(${l.id},${l.p})">${l.p} TL</button>`;
                body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name">${l.n}</span></div>${btn}</div>`;
            });
        }
        else if(type === 'quests') {
            title.innerText = "Hedefler";
            if(game.quests.every(q=>q.claimed)) {
                let remaining = 10 - (game.questCooldown || 0);
                body.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa">T√ºm g√∂revler tamamlandƒ±.<br>Yenilenmesine: <b>${remaining}</b> tur kaldƒ±.</div>`;
            } else {
                game.quests.forEach((q, i) => {
                    if(q.claimed) return;
                    let btn = q.current >= q.target ? `<button class="btn-small" style="background:var(--gold); color:black" onclick="claimQuest(${i})">Al</button>` : `${q.current}/${q.target}`;
                    body.innerHTML += `<div class="list-item"><div class="item-left"><span class="item-name">${q.desc}</span></div>${btn}</div>`;
                });
            }
        }
        else if(type === 'pedia') {
            title.innerText = "Rehber";
            let grid = document.createElement("div"); grid.style.cssText="display:grid; grid-template-columns:repeat(4,1fr); gap:8px";
            let allFish = [];
            Object.values(FISH_DB).forEach(arr => arr.forEach(f => { if(f.t!=='junk') allFish.push(f) }));
            allFish.forEach(f => {
                let data = game.pedia[f.n];
                let op = data ? 1 : 0.3;
                let bg = data ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.3)';
                grid.innerHTML += `<div style="background:${bg}; opacity:${op}; border-radius:8px; aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">${f.e}</div>`;
            });
            body.appendChild(grid);
        }
    }

    function closeModal() {
        const overlay = document.getElementById("modal-overlay");
        const modal = document.getElementById("active-modal");
        modal.style.transform = "translateY(100%)";
        overlay.style.opacity = 0;
        setTimeout(() => { overlay.style.display = "none"; }, 300);
    }

    function addToAqua(idx) {
        let f = game.bag[idx];
        if(game.aquarium.length >= game.aquaLimit) { showToast("Akvaryum Dolu!", "red"); return; }
        game.bag.splice(idx, 1); game.aquarium.push(f);
        showToast("Akvaryuma eklendi", "var(--accent)");
        saveGame(); openModal('bag'); updateUI();
    }
    function calcAquaIncome() {
        let inc = 0;
        game.aquarium.forEach(f => { if(f.r>1) inc += f.r * 5; else inc += 2; });
        return inc;
    }
    function unlockLoc(id, p) { if(game.money >= p) { game.money -= p; game.unlockedLocs.push(id); changeLoc(id); } }
    function buyBait(id, p) { if(game.money >= p) { game.money -= p; game.bait = id; showToast("Yem Takƒ±ldƒ±", "var(--accent)"); saveGame(); updateUI(); } }
    function buyRod(id, p) { if(game.money >= p) { game.money -= p; game.ownedRods.push(id); game.rodId = id; game.rodHp = RODS[id].hp; updateRodVisual(); saveGame(); updateUI(); } }
    function equipRod(id) { game.rodId = id; game.rodHp = RODS[id].hp; updateRodVisual(); saveGame(); updateUI(); }
    function repair() { if(game.money>=50) { game.money-=50; game.rodHp = RODS[game.rodId].hp; saveGame(); updateUI(); } }
    function upgBag() { if(game.money>=500) { game.money-=500; game.bagLimit+=5; saveGame(); updateUI(); } }
    function sellAll() {
        if(!game.bag.length) return;
        let total = 0;
        let bonus = 1 + (game.skills.haggle * 0.1);
        game.bag.forEach(f => { if(f.t!=='junk') total += Math.floor(f.v * bonus); else total += 1; });
        game.money += total; 
        game.quests.forEach(q => { if(q.type === 'money' && !q.claimed) q.current += total; });
        game.bag = [];
        showToast(`+${total} TL`, "var(--gold)");
        saveGame(); updateUI(); closeModal();
    }
    function claimQuest(i) { let q = game.quests[i]; q.claimed = true; game.money += q.reward; saveGame(); openModal('quests'); updateUI(); }
    function buySkill(id, cost) { if(game.money >= cost) { game.money -= cost; game.skills[id]++; saveGame(); openModal('skills'); updateUI(); } }

    function showToast(msg, col="white", sub="") {
        const t = document.getElementById("toast");
        const m = document.getElementById("toast-msg");
        const s = document.getElementById("toast-sub");
        m.innerText = msg; m.style.color = col; s.innerText = sub;
        t.style.opacity = 1; t.style.top = "140px";
        setTimeout(() => { t.style.opacity = 0; t.style.top = "120px"; }, 2000);
    }
    function saveGame() { game.lastLogin = Date.now(); localStorage.setItem("balikciHasanSave_v4", JSON.stringify(game)); }
    function loadGame() { const s = localStorage.getItem("balikciHasanSave_v4"); if(s) Object.assign(game, JSON.parse(s)); }

    init();
</script>
</body>
</html>