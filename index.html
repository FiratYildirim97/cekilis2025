<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yƒ±lba≈üƒ± √áekili≈üi 2025 üéÑ</title>

    <!-- EmailJS K√ºt√ºphanesi (v4) -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 5px solid #d32f2f;
        }
        .header {
            background: #d32f2f;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content { padding: 20px; }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .btn-add { background: #2e7d32; color: white; }
        .btn-add:active { background: #1b5e20; transform: scale(0.98); }

        .btn-draw { 
            background: #d32f2f; 
            color: white; 
            font-size: 18px; 
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        }
        .btn-draw:active { transform: scale(0.98); }
        .btn-draw:disabled { background: #ccc; cursor: not-allowed; }

        ul { list-style: none; padding: 0; margin: 0; }
        li {
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background: transparent;
            color: red;
            width: auto;
            padding: 5px 10px;
            margin: 0;
        }

        #status-area {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            color: #555;
            min-height: 20px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d32f2f;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üéÖ Yƒ±lba≈üƒ± √áekili≈üi üéÑ</h2>
        <p style="margin:0; font-size:14px; opacity:0.9">Gizli Hediyele≈üme Robotu</p>
    </div>

    <div class="content">
        <input type="text" id="isim" placeholder="ƒ∞sim (√ñrn: Ahmet)">
        <input type="email" id="mail" placeholder="Mail (√ñrn: ahmet@gmail.com)">

        <button class="btn-add" onclick="kisiEkle()">‚ûï Ki≈üiyi Ekle</button>

        <h4 style="margin: 15px 0 5px 0; color:#555;">Liste (<span id="sayac">0</span> Ki≈üi)</h4>
        <ul id="liste" style="border:1px solid #eee; border-radius:8px; overflow:hidden;">
            <li style="justify-content:center; color:#999; padding:20px;" id="bos-mesaj">Hen√ºz kimse eklenmedi.</li>
        </ul>

        <div id="status-area"></div>
        <div class="loader" id="loading-spinner"></div>

        <button class="btn-draw" onclick="baslat()">üé≤ √áEKƒ∞Lƒ∞≈ûƒ∞ BA≈ûLAT</button>
    </div>
</div>

<script type="text/javascript">
    const SERVICE_ID = "service_mfzzt76";
    const TEMPLATE_ID = "template_u8g7p0h";
    const PUBLIC_KEY = "uvwW14mqvv1uX2RgA";

    let katilimcilar = [];

    window.onload = function() {
        if (typeof emailjs === "undefined") {
            alert("‚ö†Ô∏è EmailJS y√ºklenemedi!");
        } else {
            emailjs.init({
                publicKey: PUBLIC_KEY,
                blockHeadless: false
            });
        }
    };

    function kisiEkle() {
        const isimInp = document.getElementById("isim");
        const mailInp = document.getElementById("mail");
        const isim = isimInp.value.trim();
        const mail = mailInp.value.trim();

        if (!isim || !mail) {
            alert("L√ºtfen isim ve mail girin.");
            return;
        }

        katilimcilar.push({ isim, mail });
        listeyiCiz();

        isimInp.value = "";
        mailInp.value = "";
        isimInp.focus();
    }

    function kisiSil(index) {
        katilimcilar.splice(index, 1);
        listeyiCiz();
    }

    function listeyiCiz() {
        const ul = document.getElementById("liste");
        const sayac = document.getElementById("sayac");
        ul.innerHTML = "";
        sayac.innerText = katilimcilar.length;

        if (katilimcilar.length === 0) {
            ul.innerHTML = '<li style="justify-content:center; color:#999; padding:20px;">Liste bo≈ü.</li>';
            return;
        }

        katilimcilar.forEach((kisi, index) => {
            const li = document.createElement("li");
            li.innerHTML = `
                <span><strong>${kisi.isim}</strong> <br><small style="color:#777">${kisi.mail}</small></span>
                <button class="delete-btn" onclick="kisiSil(${index})">Sil ‚úï</button>
            `;
            ul.appendChild(li);
        });
    }

    async function baslat() {
        if (katilimcilar.length < 3) {
            alert("En az 3 ki≈üi gerekli!");
            return;
        }

        if (!confirm("√áekili≈ü ba≈ülƒ±yor, mail g√∂nderilecek. Emin misin?")) return;

        const btn = document.querySelector(".btn-draw");
        const status = document.getElementById("status-area");
        const spinner = document.getElementById("loading-spinner");

        btn.disabled = true;
        btn.innerHTML = "‚è≥ Bekleyin...";
        spinner.style.display = "block";

        try {
            let alanlar = [...katilimcilar];
            let verenler = [...katilimcilar];
            let gecerli = false;

            while (!gecerli) {
                alanlar.sort(() => Math.random() - 0.5);
                gecerli = true;
                for (let i = 0; i < verenler.length; i++) {
                    if (verenler[i].mail === alanlar[i].mail) {
                        gecerli = false;
                        break;
                    }
                }
            }

            for (let i = 0; i < verenler.length; i++) {
                const veren = verenler[i];
                const alan = alanlar[i];

                status.innerText = `G√∂nderiliyor: ${i + 1} / ${verenler.length}`;

                await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
                    to_name: veren.isim,
                    gift_target: alan.isim,
                    to_email: veren.mail
                });

                await new Promise(r => setTimeout(r, 1200));
            }

            status.innerText = "‚úÖ Bitti!";
            alert("√áekili≈ü tamamlandƒ±!");

            katilimcilar = [];
            listeyiCiz();
            btn.disabled = false;
            btn.innerHTML = "üéâ Tekrar Ba≈ülat";
            spinner.style.display = "none";

        } catch (err) {
            console.error(err);
            alert("Hata: " + JSON.stringify(err));
            btn.disabled = false;
            btn.innerHTML = "Tekrar Dene";
            spinner.style.display = "none";
        }
    }
</script>

</body>
</html>
